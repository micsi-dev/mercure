{% extends "base.html" %}

{% block title %}Queue{% endblock %}

{% block extra_head %}
    <script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='DataTables/datatables.min.js') }}"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', path='DataTables/datatables.min.css') }}"/>
    <script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='js/jquery.json-viewer.js') }}"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', path='css/jquery.json-viewer.css') }}"/>
    <!-- Advanced DICOM Viewer -->
    <script nonce="{{ csp_nonce }}" type="text/javascript" src="{{ url_for('static', path='js/advanced-dicom-viewer.js') }}"></script>
{% endblock %}

{% block content %}
<main role="main">
    <div class="container">
        <div class="columns">
            <div class="column">
                <h1 class="title">Queue Management</h1>
            </div>
            <div class="column">
                <div class="container">
                    <div class="field is-grouped is-pulled-right">
                        <p class="control" style="margin-right: 5px;">
                            <button class="button is-small has-tooltip-left has-tooltip-success" data-tooltip="Auto Update" id="autoupdate">
                                <i class="far fa-clock"></i></button>                            
                        </p>
                        <p class="control">
                            <button class="button is-dark is-small has-tooltip-right has-tooltip-success"
                            data-tooltip="Refresh Now" id="refreshbtn" aria-controls="dropdown-menu">
                                <i id="activitybtn" class="fas fa-sync"></i>      
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="notification is-danger" id="erroralert" style="display: none;">
            <i class="fas fa-sync-alt"></i>&nbsp;&nbsp;Error: Unable to update queue status.
        </div>
        <h5 class="title is-5 configtitle" style="margin-top: 22px;"><i
                class="fas fa-power-off has-text-success"></i>&nbsp;&nbsp;Control</h5>
        <div class="columns">
            <div class="column" style="width: 100% !important;">
                <table class="table is-fullwidth">
                    <col width="30%">
                    <col width="30%">
                    <col width="40%">
                    <tr>
                        <td><span class="icon"><i class="fa fa-microchip"></i></span> Processing</td>
                        <td>
                            <div class="control">
                                <div class="tags has-addons">
                                    <span class="tag is-dark">Status</span>
                                    <span class="tag tagback" id="processing_status">IDLE</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="field">
                                <input id="processing_control" type="checkbox" name="processing_control"
                                    class="switch is-rounded is-danger" {% if
                                    processing_suspended==True %}checked{% endif %}>
                                <label for="processing_control">Suspend Queue</label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="icon"><i class="fa fa-directions"></i></span> Routing</td>
                        <td>
                            <div class="control">
                                <div class="tags has-addons">
                                    <span class="tag is-dark">Status</span>
                                    <span class="tagback tag" id="routing_status">IDLE</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="field">
                                <input id="routing_control" type="checkbox" name="routing_control"
                                    class="switch is-rounded is-danger" {% if
                                    routing_suspended==True %}checked{% endif %}>
                                <label for="routing_control">Suspend Queue</label>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <h5 class="title is-5 configtitle" style="margin-top: 60px;"><i
            class="fas fa-list has-text-success"></i>&nbsp;&nbsp;Job List</h5>
    <div class="columns">
        <div class="column" style="width: 100% !important;">
            <div class="tabs is-centered is-toggle is-toggle-rounded jobstabs" id="tabs">
                <ul>
                    <li data-tab="processing" id="tab_processing" class="is-active">
                        <a>
                            <span class="icon"><i class="fa fa-microchip"></i></span>
                            <span>Processing</span>
                        </a>
                    </li>
                    <li data-tab="routing" id="tab_routing">
                        <a>
                            <span class="icon"><i class="fas fa-directions"></i></span>
                            <span>Routing</span>
                        </a>
                    </li>
                    <li data-tab="studies" id="tab_studies">
                        <a>
                            <span class="icon"><i class="fas fa-clipboard-check"></i></span>
                            <span>Studies</span>
                        </a>
                    </li>
                    <li data-tab="fail" id="tab_fail">
                        <a>
                            <span class="icon"><i class="fas fa-bug"></i></span>
                            <span>Failure</span>
                        </a>
                    </li>
                    <li data-tab="success" id="tab_success">
                        <a>
                            <span class="icon"><i class="fas fa-check-circle"></i></span>
                            <span>Success</span>
                        </a>
                    </li>
                    <li data-tab="archive" id="tab_archive">
                        <a>
                            <span class="icon"><i class="fas fa-archive"></i></span>
                            <span>Archive</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div id="tab-content">
                <div class="panel is-active" data-content="processing">
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" id="jobs_processing">
                        <thead>
                            <tr>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Scope</th>
                                <th>Module</th>
                                <th>Status</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="panel" data-content="routing">
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" id="jobs_routing">
                        <thead>
                            <tr>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Scope</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="panel" data-content="studies">
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" style="word-wrap: break-word;" id="jobs_studies">
                        <thead>
                            <tr>
                                <th>Study ID</th>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Study UID</th>
                                <th>Rule</th>
                                <th>Completion</th>
                                <th>Created</th>
                                <th># Series</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="panel" data-content="fail">
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" id="jobs_fail">
                        <thead>
                            <tr>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Scope</th>
                                <th>Fail Stage</th>
                                <th>ID</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="panel" data-content="success">
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" id="jobs_success">
                        <thead>
                            <tr>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Scope</th>
                                <th>Rule</th>
                                <th>ID</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div class="panel" data-content="archive">
                    <div class="field has-addons" style="margin-top: 30px; margin-bottom: 30px;">
                        <div class="control is-expanded">
                            <input name="job_archive_search" id="job_archive_search" pattern="[0-9a-zA-Z_\-]+"
                            class="input series_completion_fix" autocomplete='off' type="text" placeholder="Find job by ACC, MRN, or patient name">
                        </div>
                        <div class="control">
                            <button class="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <table class="table is-narrow is-hoverable is-fullwidth jobtable" id="jobs_archive">
                        <thead>
                            <tr>
                                <th>ACC</th>
                                <th>MRN</th>
                                <th>Scope</th>
                                <th>Rule</th>
                                <th>Time</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="min-height: 80px; margin-top: 30px;">
                <div class="fa-3x loadingspinner" id="loadingspinner" style="display: none;">
                    <i class="fas fa-spinner fa-pulse"></i>
                </div>            
            </div>
        </div>
    </div>
    </div>

    <div class="modal" id="jobinformation">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 960px; min-height: 75%; max-height: 75%;">
            <header class="modal-card-head">
                <p class="modal-card-title">Job Information</p>
            </header>
            <section class="modal-card-body">
                <div class="container">
                    <div class="field">
                        <div class="control" id="jobinfocontrol" >
                            <pre id="jobinfo-renderer"></pre>
                            <div id="jobinformationcontent"></div>
                        </div>
                    </div>                    
                </div>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button" type="button" id="closejobinformation"><span class="icon"><i class="fas fa-check"></i></span><span>Close</span></button>
            </footer>
        </div>
    </div>    

    <div class="modal" id="jobarchiveinformation">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 960px; min-height: 75%; max-height: 75%;">
            <header class="modal-card-head">
                <p class="modal-card-title">Job Information</p>
            </header>
            <section class="modal-card-body jsonsection">
                <div class="container">
                    <div class="field">
                        <div class="control" id="jobarchiveinfocontrol" >
                            <section class="column">
                                <pre id="json-renderer"></pre>
                            </section>
                        </div>
                    </div>                    
                </div>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button" type="button" id="closejobarchiveinformation"><span class="icon"><i class="fas fa-check"></i></span><span>Close</span></button>
            </footer>
        </div>
    </div>        

    <div class="modal" id="jobaudittrail">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 90%;">
            <header class="modal-card-head">
                <p class="modal-card-title">Audit Trail</p>
            </header>
            <section class="modal-card-body">
                <table class="table is-narrow is-hoverable is-fullwidth display nowrap" id="job-events-table" width="100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Time</th>
                            <th>Event</th>
                            <th>Sender</th>
                            <th>Target</th>
                            <th>File Count</th>
                            <th>Info</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button" type="button" id="closejobaudittrail"><span class="icon"><i class="fas fa-check"></i></span><span>Close</span></button>
            </footer>
        </div>
    </div> 

    <div class="modal" id="process_logs">
        <div class="modal-background"></div>
        <div class="modal-card process-logs" style="width: 90%;">
            <header class="modal-card-head">
                <p class="modal-card-title">Processing Log</p>
            </header>
            <section class="modal-card-body process-logs" style="background-color: #0a0a0a; border-left: 3px solid #FFF; border-right: 3px solid #FFF;">
                <pre id="process_logs_display" class="process-logs process-logs-output"></pre>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button" type="button" id="closeprocesslogs"><span class="icon"><i class="fas fa-check"></i></span><span>Close</span></button>
            </footer>
        </div>
    </div> 

    <div class="modal" id="process_results">
        <div class="modal-background"></div>
        <div class="modal-card process-results" style="width: 60%;">
            <header class="modal-card-head">
                <p class="modal-card-title">Processing Results</p>
            </header>
            <section class="modal-card-body process-results" style="background-color: #0a0a0a; border-left: 3px solid #FFF; border-right: 3px solid #FFF;">
                <pre id="process_results_display" class="process-results process-results-output"></pre>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button" type="button" id="closeprocessresults"><span class="icon"><i class="fas fa-check"></i></span><span>Close</span></button>
            </footer>
        </div>
    </div>

    <div class="modal" id="reprocess_settings_modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 700px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Reprocess with Settings</p>
            </header>
            <section class="modal-card-body">
                <div class="container">
                    <input type="hidden" id="reprocess_task_id" value="">
                    <div class="field">
                        <label class="checkbox">
                            <input type="checkbox" id="use_current_settings" checked>
                            Use current rule/module settings from configuration
                        </label>
                        <p class="help">When checked, the task will be reprocessed using the current settings defined in the rule configuration.</p>
                    </div>
                    <div class="field" id="custom_settings_field" style="display: none;">
                        <label class="label">Custom Module Settings (JSON)</label>
                        <div class="control">
                            <textarea class="textarea" id="custom_module_settings" data-json rows="10" placeholder='{"key": "value"}'>{}</textarea>
                        </div>
                        <p class="help">Enter custom settings as JSON. These settings will be merged with the default module settings.</p>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot buttons is-centered">
                <button class="button is-success" type="button" id="confirm_reprocess">
                    <span class="icon"><i class="fas fa-redo-alt"></i></span><span>Reprocess</span>
                </button>
                <button class="button" type="button" id="close_reprocess_modal">
                    <span class="icon"><i class="fas fa-times"></i></span><span>Cancel</span>
                </button>
            </footer>
        </div>
    </div>

    <div class="modal" id="pdf_viewer_modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 80%; height: 90%;">
            <header class="modal-card-head">
                <p class="modal-card-title">PDF Preview</p>
                <button class="delete" aria-label="close" id="close_pdf_viewer_x"></button>
            </header>
            <section class="modal-card-body" style="padding: 0;">
                <iframe id="pdf_frame" style="width: 100%; height: 100%; border: none;"></iframe>
            </section>
            <footer class="modal-card-foot" style="justify-content: center;">
                <button class="button" id="close_pdf_viewer">Close</button>
            </footer>
        </div>
    </div>

    <!-- Series Selector Modal -->
    <div class="modal" id="series_selector_modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="max-width: 600px;">
            <header class="modal-card-head">
                <p class="modal-card-title">Select Series to View</p>
                <button class="delete" aria-label="close" id="close_series_selector_x"></button>
            </header>
            <section class="modal-card-body" id="series_selector_task_id">
                <p class="mb-4">This study contains multiple DICOM series. Please select the series you want to view:</p>
                <div class="series-selector-list" id="series_selector_list">
                    <!-- Series items will be populated dynamically -->
                </div>
            </section>
            <footer class="modal-card-foot" style="justify-content: center;">
                <button class="button" id="close_series_selector">Cancel</button>
            </footer>
        </div>
    </div>

    <!-- Advanced 3D DICOM Viewer Modal -->
    <div class="modal" id="advanced_dicom_viewer_modal">
        <div class="modal-background"></div>
        <div class="modal-card advanced-viewer-modal">
            <button class="delete advanced-viewer-close" aria-label="close" id="close_advanced_viewer_x"></button>
            <section class="modal-card-body advanced-viewer-body" style="border-radius: 6px;">
                <div class="advanced-viewer-container">
                    <!-- Loading overlay -->
                    <div class="advanced-viewer-loading" id="advanced_viewer_loading">
                        <div class="loading-content">
                            <i class="fas fa-spinner fa-pulse fa-3x"></i>
                            <p id="loading_status">Initializing viewer...</p>
                            <progress class="progress is-success" id="loading_progress" value="0" max="100">0%</progress>
                        </div>
                    </div>

                    <!-- 4-quadrant grid -->
                    <div class="viewer-grid">
                        <!-- Axial viewport -->
                        <div class="viewport-container" id="viewport_axial_container">
                            <div class="viewport" id="viewport_axial"></div>
                            <div class="orientation-labels">
                                <span class="orientation-top">A</span>
                                <span class="orientation-bottom">P</span>
                                <span class="orientation-left">R</span>
                                <span class="orientation-right">L</span>
                            </div>
                            <div class="slice-info" id="axial_slice_info">Slice: 0/0</div>
                        </div>

                        <!-- Sagittal viewport -->
                        <div class="viewport-container" id="viewport_sagittal_container">
                            <div class="viewport" id="viewport_sagittal"></div>
                            <div class="orientation-labels">
                                <span class="orientation-top">S</span>
                                <span class="orientation-bottom">I</span>
                                <span class="orientation-left">A</span>
                                <span class="orientation-right">P</span>
                            </div>
                            <div class="slice-info" id="sagittal_slice_info">Slice: 0/0</div>
                        </div>

                        <!-- Coronal viewport -->
                        <div class="viewport-container" id="viewport_coronal_container">
                            <div class="viewport" id="viewport_coronal"></div>
                            <div class="orientation-labels">
                                <span class="orientation-top">S</span>
                                <span class="orientation-bottom">I</span>
                                <span class="orientation-left">R</span>
                                <span class="orientation-right">L</span>
                            </div>
                            <div class="slice-info" id="coronal_slice_info">Slice: 0/0</div>
                        </div>

                        <!-- Control panel -->
                        <div class="control-panel" id="viewer_control_panel">
                            <h6 class="control-section-title">Window/Level</h6>

                            <div class="field">
                                <label class="label is-small">Presets</label>
                                <div class="select is-small is-fullwidth">
                                    <select id="windowing_preset">
                                        <option value="custom">Custom</option>
                                        <optgroup label="CT">
                                            <option value="ct_brain">CT Brain (W:80 L:40)</option>
                                            <option value="ct_bone">CT Bone (W:2000 L:500)</option>
                                            <option value="ct_lung">CT Lung (W:1500 L:-600)</option>
                                            <option value="ct_abdomen">CT Abdomen (W:400 L:40)</option>
                                            <option value="ct_liver">CT Liver (W:150 L:30)</option>
                                        </optgroup>
                                        <optgroup label="MR">
                                            <option value="mr_t1">MR T1 (W:500 L:250)</option>
                                            <option value="mr_t2">MR T2 (W:400 L:200)</option>
                                        </optgroup>
                                        <optgroup label="PET">
                                            <option value="pet_suv">PET SUV (W:10 L:5)</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label is-small">Min / Max</label>
                                <div class="field has-addons">
                                    <p class="control is-expanded">
                                        <input class="input is-small" type="number" id="window_min_input" placeholder="Min" style="background:#363636;color:#fff;border-color:#555;">
                                    </p>
                                    <p class="control is-expanded">
                                        <input class="input is-small" type="number" id="window_max_input" placeholder="Max" style="background:#363636;color:#fff;border-color:#555;">
                                    </p>
                                </div>
                            </div>

                            <div class="windowing-info" style="font-size: 11px; color: #888; margin-bottom: 12px;">
                                <span>W: <span id="window_width_value">400</span></span> &nbsp;|&nbsp;
                                <span>L: <span id="window_level_value">40</span></span>
                            </div>

                            <h6 class="control-section-title">View Layout</h6>

                            <div class="field">
                                <div class="buttons are-small has-addons view-layout-buttons">
                                    <button class="button is-dark is-active" id="view_all" data-layout="all" title="All Views">
                                        <span class="icon"><i class="fas fa-th-large"></i></span>
                                    </button>
                                    <button class="button is-dark" id="view_axial" data-layout="axial" title="Axial Only">
                                        <span>Ax</span>
                                    </button>
                                    <button class="button is-dark" id="view_sagittal" data-layout="sagittal" title="Sagittal Only">
                                        <span>Sag</span>
                                    </button>
                                    <button class="button is-dark" id="view_coronal" data-layout="coronal" title="Coronal Only">
                                        <span>Cor</span>
                                    </button>
                                </div>
                            </div>

                            <h6 class="control-section-title">Display</h6>

                            <div class="field">
                                <label class="label is-small">Colormap</label>
                                <div class="select is-small is-fullwidth">
                                    <select id="colormap_select">
                                        <option value="gray">Grayscale</option>
                                        <option value="inverted">Inverted</option>
                                        <option value="hot">Hot</option>
                                        <option value="cool">Cool</option>
                                        <option value="jet">Jet</option>
                                    </select>
                                </div>
                            </div>

                            <div class="field">
                                <label class="checkbox is-small" style="color: #ccc;">
                                    <input type="checkbox" id="colorbar_toggle">
                                    Show Colorbar
                                </label>
                            </div>

                            <div class="field">
                                <label class="checkbox is-small" style="color: #ccc;">
                                    <input type="checkbox" id="interpolation_toggle" checked>
                                    Smooth Interpolation
                                </label>
                            </div>

                            <h6 class="control-section-title">Tools</h6>

                            <div class="buttons are-small tool-buttons">
                                <button class="button is-dark tool-btn is-active" id="tool_crosshairs" data-tool="crosshairs" title="Crosshairs">
                                    <span class="icon"><i class="fas fa-crosshairs"></i></span>
                                </button>
                                <button class="button is-dark tool-btn" id="tool_zoom" data-tool="zoom" title="Zoom">
                                    <span class="icon"><i class="fas fa-search-plus"></i></span>
                                </button>
                                <button class="button is-dark tool-btn" id="tool_pan" data-tool="pan" title="Pan">
                                    <span class="icon"><i class="fas fa-arrows-alt"></i></span>
                                </button>
                                <button class="button is-dark tool-btn" id="tool_window" data-tool="window" title="Window/Level">
                                    <span class="icon"><i class="fas fa-adjust"></i></span>
                                </button>
                                <button class="button is-warning" id="tool_reset" title="Reset View">
                                    <span class="icon"><i class="fas fa-undo"></i></span>
                                </button>
                            </div>

                            <!-- 4D Controls (hidden by default) -->
                            <div id="controls_4d" style="display: none;">
                                <h6 class="control-section-title">4D Playback</h6>
                                <div class="field">
                                    <label class="label is-small">Timepoint: <span id="timepoint_value">1</span> / <span id="timepoint_max">1</span></label>
                                    <input class="slider is-fullwidth" id="timepoint_slider" type="range" min="1" max="1" value="1">
                                </div>
                                <div class="buttons are-small">
                                    <button class="button is-success" id="btn_play">
                                        <span class="icon"><i class="fas fa-play"></i></span>
                                    </button>
                                    <button class="button is-warning" id="btn_pause" style="display: none;">
                                        <span class="icon"><i class="fas fa-pause"></i></span>
                                    </button>
                                    <button class="button is-dark" id="btn_stop">
                                        <span class="icon"><i class="fas fa-stop"></i></span>
                                    </button>
                                </div>
                            </div>

                            <h6 class="control-section-title">Volume Info</h6>
                            <div class="volume-info" id="volume_info">
                                <p><strong>Modality:</strong> <span id="info_modality">-</span></p>
                                <p><strong>Dimensions:</strong> <span id="info_dimensions">-</span></p>
                                <p><strong>Slices:</strong> <span id="info_slices">-</span></p>
                                <p><strong>Spacing:</strong> <span id="info_spacing">-</span></p>
                            </div>

                            <h6 class="control-section-title">Cursor Info</h6>
                            <div class="pixel-info" id="pixel_info_container" style="display: none;">
                                <p><strong>View:</strong> <span id="pixel_info_view">-</span> (Slice <span id="pixel_info_slice">-</span>)</p>
                                <p><strong>Position:</strong> <span id="pixel_info_coords">-</span></p>
                                <p><strong>Value:</strong> <span id="pixel_info_value">-</span></p>
                            </div>
                            <div class="pixel-info-placeholder" id="pixel_info_placeholder">
                                <p style="color: #666; font-style: italic;">Hover over image to see pixel info</p>
                            </div>

                            <div class="keyboard-hint">
                                <strong>Keyboard:</strong><br>
                                <kbd>&larr;</kbd><kbd>&rarr;</kbd> or <kbd>&uarr;</kbd><kbd>&darr;</kbd> Scroll slices<br>
                                <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> Focus viewport<br>
                                <kbd>R</kbd> Reset view<br>
                                <kbd>Esc</kbd> Close
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</main>

<script nonce="{{ csp_nonce }}">

    var archiveFilterQueue = false;

    function update() {
        update_status();
        update_jobs();
        $("#refreshbtn").blur();
    }


    
    function update_jobs() {
        if ($("#tab_processing").hasClass("is-active")) {    
            $('#jobs_processing').DataTable().clear().draw();
            $('#loadingspinner').show();          
            $.ajax({
                type: 'GET',
                url: '/queue/jobs/processing',
                data: {},
                dataType: 'json',
                error: function () {
                    $('#erroralert').show();
                },
                success: function (data) {
                    $('#erroralert').hide();
                    if (!Object.keys(data).length) {
                    }
                    else {
                        var jobtable = $('#jobs_processing').DataTable();
                        Object.keys(data).forEach(function (key) {
                                jobtable.row.add( [ data[key]["ACC"], data[key]["MRN"], data[key]["Scope"], data[key]["Module"], data[key]["Status"], key ] );
                        })
                        jobtable.draw();
                    }
                },
                complete: function (data) {
                    $('#loadingspinner').hide();
                },
                timeout: 3000
            });
            $('#jobs_processing').DataTable().button(2).enable(false);
            $('#jobs_processing').DataTable().button(3).enable(false);
            $('#jobs_processing').DataTable().button(4).enable(false);
            return;
        }

        if ($("#tab_routing").hasClass("is-active")) {
            $('#jobs_routing').DataTable().clear().draw();
            $('#loadingspinner').show();
            $.ajax({
                type: 'GET',
                url: '/queue/jobs/routing',
                data: {},
                dataType: 'json',
                error: function () {
                    $('#erroralert').show();
                },
                success: function (data) {
                    $('#erroralert').hide();
                    var jobtable = $('#jobs_routing').DataTable();
                    if (Object.keys(data).length) {
                        Object.keys(data).forEach(function (key) {
                            jobtable.row.add( [ data[key]["ACC"], data[key]["MRN"], data[key]["Scope"], data[key]["Target"], data[key]["Status"], key ] );
                        })
                    }
                    jobtable.draw();
                },
                complete: function (data) {
                    $('#loadingspinner').hide();
                },
                timeout: 3000
            });
            $('#jobs_routing').DataTable().button(2).enable(false);
            $('#jobs_routing').DataTable().button(3).enable(false);
            return;
        }

        if ($("#tab_studies").hasClass("is-active")) {       
            $('#jobs_studies').DataTable().clear().draw();
            $('#loadingspinner').show();
            $.ajax({
                type: 'GET',
                url: '/queue/jobs/studies',
                data: {},
                dataType: 'json',
                error: function () {
                    $('#erroralert').show();
                },
                success: function (data) {
                    $('#erroralert').hide();
                    var jobtable = $('#jobs_studies').DataTable();
                    Object.keys(data).forEach(function (key) {
                        jobtable.row.add( [ key, data[key]["ACC"], data[key]["MRN"], data[key]["UID"], data[key]["Rule"], data[key]["Completion"], data[key]["Created"], data[key]["Series"] ] );
                    })
                    jobtable.draw();
                },
                complete: function (data) {
                    $('#loadingspinner').hide();
                },
                timeout: 3000
            });
            $('#jobs_studies').DataTable().button(2).enable(false);
            $('#jobs_studies').DataTable().button(3).enable(false);
            $('#jobs_studies').DataTable().button(4).enable(false);
            return;
        }

        if ($("#tab_fail").hasClass("is-active")) {
            $('#jobs_fail').DataTable().clear().draw();
            $('#loadingspinner').show();
            $.ajax({
                type: 'GET',
                url: '/queue/jobs/fail',
                data: {},
                dataType: 'json',
                error: function () {
                    $('#erroralert').show();
                },
                success: function (data) {
                    $('#erroralert').hide();
                    var jobtable = $('#jobs_fail').DataTable();
                    Object.keys(data).forEach(function (key) {
                        jobtable.row.add( [ data[key]["ACC"], data[key]["MRN"], data[key]["Scope"], data[key]["FailStage"], key, data[key]["CreationTime"] ] );
                    })
                    jobtable.draw();
                },
                complete: function (data) {
                    $('#loadingspinner').hide();
                },
                timeout: 3000
            });
            $('#jobs_fail').DataTable().button(2).enable(false);
            $('#jobs_fail').DataTable().button(3).enable(false);
            $('#jobs_fail').DataTable().button(4).enable(false);
            $('#jobs_fail').DataTable().button(5).enable(false);
            $('#jobs_fail').DataTable().button(6).enable(false);
            return;
        }

        if ($("#tab_success").hasClass("is-active")) {
            $('#jobs_success').DataTable().clear().draw();
            $('#loadingspinner').show();
            $.ajax({
                type: 'GET',
                url: '/queue/jobs/success',
                data: {},
                dataType: 'json',
                error: function () {
                    $('#erroralert').show();
                },
                success: function (data) {
                    $('#erroralert').hide();
                    var jobtable = $('#jobs_success').DataTable();
                    Object.keys(data).forEach(function (key) {
                        jobtable.row.add( [ data[key]["ACC"], data[key]["MRN"], data[key]["Scope"], data[key]["Rule"], key, data[key]["CompletedTime"] ] );
                    })
                    jobtable.draw();
                },
                complete: function (data) {
                    $('#loadingspinner').hide();
                },
                timeout: 3000
            });
            $('#jobs_success').DataTable().button(2).enable(false);
            $('#jobs_success').DataTable().button(3).enable(false);
            return;
        }

        if ($("#tab_archive").hasClass("is-active")) {       
            $('#jobs_archive').DataTable().clear().draw();
            $('#jobs_archive_wrapper').hide();
            $('#job_archive_search').val('');
            archiveSearch();
            $('#job_archive_search').focus();                
            return;
        }        
    }

    function update_status() {
        $.ajax({
            type: 'GET',
            url: '/queue/status',
            data: {},
            dataType: 'json',
            error: function () {
                $('#erroralert').show();
                $('#jobs_processing').DataTable().clear().draw();
                $('#jobs_routing').DataTable().clear().draw();
                $('#jobs_studies').DataTable().clear().draw();
                $('#jobs_fail').DataTable().clear().draw();
                $('#jobs_success').DataTable().clear().draw();
                $('#jobs_archive').DataTable().clear().draw();
            },
            success: function (data) {
                $('#erroralert').hide();
                $('#processing_status').removeClass("is-success is-danger is-warning");
                $('#routing_status').removeClass("is-success is-danger is-warning");

                switch (data["processing_status"]) {
                    case "Idle":
                        $('#processing_status').text("IDLE");
                        break;
                    case "Processing":
                        $('#processing_status').text("RUNNING");
                        $('#processing_status').addClass("is-success");
                        break;
                    case "Halted":
                        $('#processing_status').text("HALTED");
                        $('#processing_status').addClass("is-danger");
                        break;
                    case "Suspending":
                        $('#processing_status').text("SUSPENDING");
                        $('#processing_status').addClass("is-warning");
                        break;
                    default:
                        $('#processing_status').text("UNKNOWN");
                }

                switch (data["routing_status"]) {
                    case "Idle":
                        $('#routing_status').text("IDLE");
                        break;
                    case "Processing":
                        $('#routing_status').text("RUNNING");
                        $('#routing_status').addClass("is-success");
                        break;
                    case "Halted":
                        $('#routing_status').text("HALTED");
                        $('#routing_status').addClass("is-danger");
                        break;
                    case "Suspending":
                        $('#routing_status').text("SUSPENDING");
                        $('#routing_status').addClass("is-warning");
                        break;
                    default:
                        $('#routing_status').text("UNKNOWN");
                }

                if (data["processing_suspended"] == "True") {
                    $('#processing_control').prop('checked', true);
                } else {
                    $('#processing_control').prop('checked', false);
                }

                if (data["routing_suspended"] == "True") {
                    $('#routing_control').prop('checked', true);
                } else {
                    $('#routing_control').prop('checked', false);
                }
            },
            timeout: 3000
        });
    }

    function suspendQueue() {
        var suspend_processing = $('#processing_control').is(':checked');
        var suspend_routing = $('#routing_control').is(':checked');
        $.ajax({
            type: 'POST',
            url: '/queue/status',
            data: { "suspend_processing": suspend_processing, "suspend_routing": suspend_routing },
            dataType: 'json',
            error: function () {
                $('#erroralert').show();
            },
            success: function (data) {
                $('#erroralert').hide();
                update();
            },
            timeout: 3000
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        let cardToggles = document.getElementsByClassName('card-toggle');
        for (let i = 0; i < cardToggles.length; i++) {
            cardToggles[i].addEventListener('click', e => {
                e.currentTarget.parentElement.parentElement.childNodes[3].classList.toggle('is-hidden');
            });
        }
    });

    function install_handlers() {
        // Auto update button
        $("#autoupdate").on('click', function() {
            toggleAutoUpdate();
        });
        
        // Refresh now button
        $("#refreshbtn").on('click', function() {
            update();
        });
        
        // Suspend queue checkboxes
        $("#processing_control, #routing_control").on('change', function() {
            suspendQueue();
        });
        
        // Close job information modals
        $("#closejobinformation").on('click', function() {
            closeJobInformation();
        });
        
        $("#closejobarchiveinformation").on('click', function() {
            closeJobArchiveInformation();
        });
        
        $("#closejobaudittrail").on('click', function() {
            closeJobAuditTrail();
        });
        
        $("#closeprocesslogs").on('click', function() {
            closeProcessLogs();
        });
        
        $("#closeprocessresults").on('click', function() {
            closeProcessResults();
        });

        // Reprocess modal handlers
        $("#close_reprocess_modal").on('click', function() {
            closeReprocessModal();
        });

        $("#confirm_reprocess").on('click', function() {
            confirmReprocess();
        });

        $("#use_current_settings").on('change', function() {
            if ($(this).is(':checked')) {
                $('#custom_settings_field').hide();
            } else {
                $('#custom_settings_field').show();
            }
        });

        // PDF viewer handlers
        $("#close_pdf_viewer, #close_pdf_viewer_x").on('click', function() {
            closePdfViewer();
        });

        // Series selector handlers
        $("#close_series_selector, #close_series_selector_x").on('click', function() {
            closeSeriesSelector();
        });

        // Keyboard navigation
        $(document).on('keydown', function(e) {
            if ($('#pdf_viewer_modal').hasClass('is-active')) {
                if (e.keyCode === 27) { // Escape
                    closePdfViewer();
                }
            }
            if ($('#advanced_dicom_viewer_modal').hasClass('is-active')) {
                if (e.keyCode === 27) { // Escape
                    closeAdvancedDicomViewer();
                }
            }
            if ($('#series_selector_modal').hasClass('is-active')) {
                if (e.keyCode === 27) { // Escape
                    closeSeriesSelector();
                }
            }
        });

        // Advanced DICOM viewer handlers
        $("#close_advanced_viewer_x").on('click', function() {
            closeAdvancedDicomViewer();
        });

        // Archive search button
        $(".field .button").on('click', function() {
            archiveSearch();
        });

        // Setup tabs click handlers (already done in the original code)


    }
    $(document).ready(function () {      
        install_handlers()
        $('#jobs_processing').DataTable( {
            "columnDefs": [{ targets: '_all', render: DataTable.render.text() }],
            "paging":   false,
            "ordering": false,
            "info": false,
            "searching": false,
            "language": {
                "emptyTable": "No jobs scheduled for processing"
            },
            select: true,
            buttons: [
                {   
                    extend: 'selectAll', 
                    text: '<i class="far fa-check-square"></i>',
                    titleAttr: 'Select all',
                },
                {   
                    extend: 'selectNone', 
                    text: '<i class="far fa-square"></i>',
                    titleAttr: 'Deselect all',
                },
                {
                    text: '<i class="fas fa-code"></i>',
                    titleAttr: 'Job information',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_processing').DataTable().rows( { selected: true } ).data()[0][5];
                        showJobInformation(jid,"processing");
                    }
                },
                {
                    text: '<i class="fas fa-receipt"></i>',
                    titleAttr: 'Live processing log',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_processing').DataTable().rows( { selected: true } ).data()[0][5];
                        showLiveLogs(jid);
                    }
                },
                {
                    text: '<i class="fas fa-redo-alt"></i>',
                    titleAttr: 'Restart processing with original files',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_processing').DataTable().rows( { selected: true } ).data()[0][5];
                        restartProcessingJob(jid);
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Cancel job',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_processing').DataTable().rows( { selected: true } ).data()[0][5];
                        deleteJob(jid, 'processing');
                    }
                }
            ],
            dom: 'Bfrtip',
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,
        } );
        $('#jobs_processing').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_processing').DataTable().rows( { selected: true } ).count();
            $('#jobs_processing').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_processing').DataTable().button(3).enable( selectedRows > 0 );
            $('#jobs_processing').DataTable().button(4).enable( selectedRows > 0 );
            $('#jobs_processing').DataTable().button(5).enable( selectedRows > 0 );
        } );

        $('#jobs_routing').DataTable( {
            "columnDefs": [{ targets: '_all', render: DataTable.render.text() }],
            "paging":   false,
            "ordering": false,
            "info": false,
            "searching": false,
            "language": {
                "emptyTable": "No jobs scheduled for routing"
            },
            select: true,
            buttons: [
                {   
                    extend: 'selectAll', 
                    text: '<i class="far fa-check-square"></i>',
                    titleAttr: 'Select all',
                },
                {   
                    extend: 'selectNone', 
                    text: '<i class="far fa-square"></i>',
                    titleAttr: 'Deselect all',
                },
                {
                    text: '<i class="fas fa-code"></i>',
                    titleAttr: 'Job information',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_routing').DataTable().rows( { selected: true } ).data()[0][5];
                        showJobInformation(jid,"routing");
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Cancel job',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_routing').DataTable().rows( { selected: true } ).data()[0][5];
                        deleteJob(jid, 'routing');
                    }
                },
            ],
            dom: 'Bfrtip',
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,
        } );
        $('#jobs_routing').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_routing').DataTable().rows( { selected: true } ).count();
            $('#jobs_routing').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_routing').DataTable().button(3).enable( selectedRows > 0 );
        } );

        $('#jobs_studies').DataTable( {
            "paging":   false,
            "ordering": false,
            "info": false,
            "searching": false,
            "select": true,
            "language": {
                "emptyTable": "No studies in reception"
            },
            "columnDefs": [{ targets: '_all', render: DataTable.render.text() },
                { "visible": false, "targets": 0, render: DataTable.render.text() }
            ],
            select: true,
            buttons: [
                {   
                    extend: 'selectAll', 
                    text: '<i class="far fa-check-square"></i>',
                    titleAttr: 'Select all',
                },
                {   
                    extend: 'selectNone', 
                    text: '<i class="far fa-square"></i>',
                    titleAttr: 'Deselect all',
                },
                {
                    text: '<i class="fas fa-code"></i>',
                    titleAttr: 'Job information',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_studies').DataTable().rows( { selected: true } ).data()[0][0];
                        showJobInformation(jid,"studies");
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Cancel study',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_studies').DataTable().rows( { selected: true } ).data()[0][0];
                        deleteJob(jid, 'studies');
                    }
                },
                {
                    text: '<i class="fas fa-sign-out-alt"></i>',
                    titleAttr: 'Force study completion',
                    action: function ( e, dt, node, config ) {

                        var selectedRows = $('#jobs_studies').DataTable().rows( { selected: true } )
                        
                        selectedRows.every(function() {
                            row = this
                            var id = row.data()[0]
                            if (row.data()[5] == "Force") {
                                return
                            }
                            $.ajax({
                                type: 'POST',
                                url: '/queue/jobs/studies/force-complete',
                                data: {'id': id },
                                dataType: 'json',
                                error: function () {
                                    alert("Operation failed. Try refreshing the page.")
                                },
                                success: function (data) {
                                    $('#erroralert').hide();
                                    var d = row.data();
                                    d[5] = "Force";
                                    row.data(d);
                                    row.deselect();
                                    row.invalidate();
                                },
                                complete: function (data) {
                                    $('#loadingspinner').hide();
                                },
                                timeout: 3000
                            });
                        })
                    }
                }
            ],
            dom: 'Bfrtip',
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,            
        } );
        $('#jobs_studies').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_studies').DataTable().rows( { selected: true } ).count();
            $('#jobs_studies').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_studies').DataTable().button(3).enable( selectedRows > 0 );
            $('#jobs_studies').DataTable().button(4).enable( selectedRows > 0 );            
        } );

        $('#jobs_fail').DataTable( {
            paging:   true,
            ordering: true,
            info: true,
            searching: true,
            columnDefs: [{ targets: '_all', render: DataTable.render.text() }],
            language: {
                emptyTable: "No failed jobs",
                paginate: {
                    first: "First",
                    last:  "Last",
                    next:  "&gt;",
                    previous: "&lt;"
                },
            },
            select: true,
            buttons: [
                {   
                    extend: 'selectAll', 
                    text: '<i class="far fa-check-square"></i>',
                    titleAttr: 'Select all',
                },
                {   
                    extend: 'selectNone', 
                    text: '<i class="far fa-square"></i>',
                    titleAttr: 'Deselect all',
                },
                {
                    text: '<i class="fas fa-code"></i>',
                    titleAttr: 'Job information',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][4];
                        showJobInformation(jid,"failure");
                    }
                },
                {
                    text: '<i class="fas fa-redo-alt"></i>',
                    titleAttr: 'Restart job',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][4];
                        restartJob(jid);
                    }
                },
                {
                    text: '<i class="fas fa-cogs"></i>',
                    titleAttr: 'Reprocess with settings',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][4];
                        showReprocessModal(jid);
                    }
                },
                {
                    text: '<i class="fas fa-eye"></i>',
                    titleAttr: 'Preview output',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][4];
                        checkAndOpenPreview(jid);
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Delete job',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][4];
                        deleteJob(jid, 'failure');
                    }
                }
            ],
            /*dom: 'Bfrtipf',*/
            dom: '<"columns"<"column"B><"column"f>><"columns"<"column queuetablepadding"rt>><"columns"<"column"i><"column"p><"column"f>>',
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,
            "order": [[5, 'desc'], [4, 'desc']],
            initComplete: function() {
                $('.dataTables_filter').last().hide();
                $(".dataTables_info").css("color", "#dbdbdb");
            }
        } );
        $('#jobs_fail').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_fail').DataTable().rows( { selected: true } ).count();
            $('#jobs_fail').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_fail').DataTable().button(5).enable( selectedRows > 0 );
            $('#jobs_fail').DataTable().button(6).enable( selectedRows > 0 );
            if (selectedRows == 1) {
                let failStage = $('#jobs_fail').DataTable().rows( { selected: true } ).data()[0][3];
                let isProcessingFail = failStage == "Dispatching" || failStage == "Processing";
                $('#jobs_fail').DataTable().button(3).enable(isProcessingFail);
                $('#jobs_fail').DataTable().button(4).enable(failStage == "Processing");
            } else {
                $('#jobs_fail').DataTable().button(3).enable( false );
                $('#jobs_fail').DataTable().button(4).enable( false );
            }
        } );

        $('#jobs_success').DataTable( {
            paging:   true,
            ordering: true,
            info: true,
            searching: true,
            columnDefs: [{ targets: '_all', render: DataTable.render.text() }],
            language: {
                emptyTable: "No completed jobs",
                paginate: {
                    first: "First",
                    last:  "Last",
                    next:  "&gt;",
                    previous: "&lt;"
                },
            },
            select: true,
            buttons: [
                {
                    extend: 'selectAll',
                    text: '<i class="far fa-check-square"></i>',
                    titleAttr: 'Select all',
                },
                {
                    extend: 'selectNone',
                    text: '<i class="far fa-square"></i>',
                    titleAttr: 'Deselect all',
                },
                {
                    text: '<i class="fas fa-eye"></i>',
                    titleAttr: 'Preview output',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_success').DataTable().rows( { selected: true } ).data()[0][4];
                        checkAndOpenPreview(jid);
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Delete job',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_success').DataTable().rows( { selected: true } ).data()[0][4];
                        deleteJob(jid, 'success');
                    }
                }
            ],
            dom: '<"columns"<"column"B><"column"f>><"columns"<"column queuetablepadding"rt>><"columns"<"column"i><"column"p><"column"f>>',
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,
            "order": [[5, 'desc'], [4, 'desc']],
            initComplete: function() {
                $('.dataTables_filter').last().hide();
                $(".dataTables_info").css("color", "#dbdbdb");
            }
        } );
        $('#jobs_success').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_success').DataTable().rows( { selected: true } ).count();
            $('#jobs_success').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_success').DataTable().button(3).enable( selectedRows > 0 );
        } );

        $('#jobs_archive').DataTable( {
            "columnDefs": [{ targets: '_all', render: DataTable.render.text() }],
            paging:   true,
            ordering: true,
            // "info": false,
            searching: true,
            select: true,
            language: {
                emptyTable: "No jobs found",
                paginate: {
                    first:      "First",
                    last:       "Last",
                    next:       "&gt;",
                    previous:   "&lt;"
                },                
            },
            ajax: {
                url: '/api/find-tasks',
                data: function(d) {
                    // Add the study filter parameter to the request
                    d.study_filter = archiveFilterQueue;
                }
            },
            columns: [
                { data: 'ACC' },
                { data: 'MRN' },
                { data: 'Scope' },
                { data: 'Rule' },
                { data: 'Time' },
                { data: 'task_id' },
            ],
            serverSide: true,
            autoWidth: false,
            // select: true,
            buttons: [
                {
                    extend: 'collection',
                    autoClose: true,
                    text: '<i class="fas fa-filter"></i>',
                    className: 'queueArchiveFilter',
                    titleAttr: 'Job filter',
                    buttons: [
                        {
                            text: 'Show only STUDY jobs',
                            className: 'queueArchiveFilterButton',
                            action: function (e, dt, node, config, cb) {
                                // Toggles class when pressed
                                $(e.currentTarget).toggleClass("queueArchiveFilterButton-Checked");                       
                                archiveFilterQueue = !archiveFilterQueue;
                                dt.ajax.reload();
                            }
                        }
                    ]
                },
                {
                    text: '<i class="fas fa-code"></i>',
                    titleAttr: 'Job information',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_archive').DataTable().rows( { selected: true } ).data()[0].task_id;
                        showArchiveJobInformation(jid);
                    }
                },
                {
                    text: '<i class="fas fa-list-ul"></i>',
                    titleAttr: 'Audit trail',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_archive').DataTable().rows( { selected: true } ).data()[0].task_id;
                        showAuditTrail(jid);
                    }
                },
                {
                    text: '<i class="fas fa-receipt"></i>',
                    titleAttr: 'Processing log',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_archive').DataTable().rows( { selected: true } ).data()[0].task_id;
                        showLogs(jid);
                    }
                },
                {
                    text: '<i class="fas fa-chart-bar"></i>',
                    titleAttr: 'Processing results',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_archive').DataTable().rows( { selected: true } ).data()[0].task_id;
                        showResults(jid);
                    }
                },
                {
                    text: '<i class="fas fa-trash-alt"></i>',
                    titleAttr: 'Delete from archive',
                    action: function ( e, dt, node, config ) {
                        var jid = $('#jobs_archive').DataTable().rows( { selected: true } ).data()[0].task_id;
                        deleteArchiveJob(jid);
                    }
                }
            ],
            dom: '<"columns"<"column"B>><"columns"<"column queuetablepadding"rt>><"columns"<"column"i><"column"p><"column"f>>',
            /*dom: 'Brtip',*/
            "scrollY": "740px",
            "scrollX": false,
            "scrollCollapse": true,
            "order": [[4, 'desc'], [5, 'desc']],
            initComplete: function() {
                $('.queueArchiveFilter > .dt-down-arrow').hide()
                $('.queueArchiveFilter > .icon').hide()
            }
        } );
        $('#jobs_archive').DataTable().on( 'select deselect', function () {
            var selectedRows = $('#jobs_archive').DataTable().rows( { selected: true } ).count();
            $('#jobs_archive').DataTable().button(1).enable( selectedRows > 0 );
            $('#jobs_archive').DataTable().button(2).enable( selectedRows > 0 );
            $('#jobs_archive').DataTable().button(3).enable( selectedRows > 0 );
            $('#jobs_archive').DataTable().button(4).enable( selectedRows > 0 );
            $('#jobs_archive').DataTable().button(5).enable( selectedRows > 0 );
        } );
        $("#job_archive_search").on('keyup', function (event) {
            event.target.value = event.target.value.replace(/[{}\x22\n]/g, '');
            if (event.keyCode === 13) {
                archiveSearch();
            }
        });

        $('#job-events-table').DataTable( {
            "paging": false,
            "ordering": false,
            "searching": false,
            "language": {
                "emptyTable": "No events found."
            },
            dom: 'Bfrtp',
            "scrollY": "740px",
            "scrollX": true,
            "scrollCollapse": true,   
            "drawCallback": function (settings) {
                var api = this.api();
                var rows = api.rows({ page: 'current' }).nodes();
                var last = null;
                api
                    .column(0, { page: 'current' })
                    .data()
                    .each(function (group, i) {
                        if (last !== group) {
                            $(rows)
                                .eq(i)
                                .before('<tr class="group"><td colspan="7" class="has-text-white has-background-dark"><i class="fas fa-angle-double-right" style="color: hsl(141, 71%, 48%);"></i> Task ' + group + '</td></tr>');
                            last = group;
                        }
                    });
            },
            "columnDefs": [{ targets: '_all', render: DataTable.render.text() },
              { "visible": false, "targets": 0, render: DataTable.render.text() }
            ]
        });

        $('#tabs li').on('click', function () {
            var tab = $(this).data('tab');

            $('#tabs li').removeClass('is-active');
            $(this).addClass('is-active');

            $('#tab-content div.panel').removeClass('is-active');
            $('div.panel[data-content="' + tab + '"]').addClass('is-active');

            update();
        });       
       
        update();
    });

    function archiveSearch()
    {
        if ($("#tab_archive").hasClass("is-active")) {
            $('#jobs_archive_filter').hide();
            $('#jobs_archive_filter input').val($('#job_archive_search').val());
            $('#jobs_archive_filter input').trigger(jQuery.Event("keyup", { which: 13 }));
            $('#jobs_archive_wrapper').show();
            return;
        }
    }

    function showLogs(jobId)
    {
        if (jobId === "") {
            return;
        }
        $("#process_logs").addClass("is-loading");   

        $.ajax({
            type: 'GET',
            url: '/api/task-process-logs',
            data: {'task_id': jobId},
            dataType: 'json',
            error: function () {
                // $('#erroralert').show();
                $("#process_logs_display").text("Unable to load processing logs for the selected task.")
            },
            success: function (data) {
                if (data && data.length > 0) {
                    var logText = "";
                    for (var i = 0; i < data.length; i++) {
                        logText += "### Module " + (i+1).toString()  +  " -- Begin\n\n";
                        logText += data[i].logs;
                        logText += "\n### Module " + (i+1).toString() + " -- Complete\n\n";
                    }
                    $("#process_logs_display").text(logText);
                } else {
                    $("#process_logs_display").text("No processing log available for selected task.")
                }
                $("#process_logs").addClass("is-active");
            },
            timeout: 5000
        });
    }

    var liveLogsInterval = null;

    function showLiveLogs(jobId) {
        if (jobId === "") {
            return;
        }

        $("#process_logs_display").text("Loading live logs...");
        $("#process_logs").addClass("is-active");

        // Start polling for live logs
        function fetchLiveLogs() {
            $.ajax({
                type: 'GET',
                url: '/api/task-live-logs/' + jobId,
                dataType: 'json',
                error: function () {
                    $("#process_logs_display").text("Unable to load live logs for the selected task.");
                },
                success: function (data) {
                    if (data.status === "processing" || data.status === "starting") {
                        if (data.logs) {
                            $("#process_logs_display").text(data.logs);
                            // Auto-scroll to bottom
                            var logDiv = document.getElementById('process_logs_display');
                            logDiv.scrollTop = logDiv.scrollHeight;
                        } else {
                            $("#process_logs_display").text("Waiting for logs... (processing starting)");
                        }
                    } else {
                        // Not processing anymore, try to get completed logs
                        clearInterval(liveLogsInterval);
                        liveLogsInterval = null;
                        showLogs(jobId);
                    }
                },
                timeout: 5000
            });
        }

        // Initial fetch
        fetchLiveLogs();

        // Poll every 2 seconds
        if (liveLogsInterval) {
            clearInterval(liveLogsInterval);
        }
        liveLogsInterval = setInterval(fetchLiveLogs, 2000);
    }

    function showResults(jobId)
    {
        if (jobId === "") {
            return;
        }
        $("#process_results").addClass("is-loading");   

        $.ajax({
            type: 'GET',
            url: '/api/task-process-results',
            data: {'task_id': jobId},
            dataType: 'json',
            error: function () {
                // $('#erroralert').show();
                $("#process_results_display").text("Unable to load processing results for the selected task.")
            },
            success: function (data) {
                if (data && data.length > 0) {
                    var resultsText = "";
                    for (var i = 0; i < data.length; i++) {
                        resultsText += "### Module " + data[i].module + "\n\n";
                        resultsText += JSON.stringify(data[i].output, null, 4);
                        resultsText += "\n\n";
                    }
                    $("#process_results_display").text(resultsText);
                } else {
                    $("#process_results_display").text("No processing results exist for the selected task.")
                }
                $("#process_results").addClass("is-active");
            },
            timeout: 5000
        });
    }

    function showAuditTrail(jobId)
    {
        if (jobId === "") {
            return;
        }

        console.log("Showing audit trail for job " + jobId);

        $("#jobaudittrail").addClass("is-active");
        $("#jobaudittrail").addClass("is-loading");        

        $.ajax({
            type: 'GET',
            url: '/api/get-task-events',
            data: {'task_id': jobId},
            dataType: 'json',
            error: function () {
                // $('#erroralert').show();
                var eventstable = $('#job-events-table').DataTable();
                eventstable.clear();                
                eventstable.draw();
            },
            success: function (data) {
                var eventstable = $('#job-events-table').DataTable();
                eventstable.clear();
                Object.keys(data).forEach(function (key) {
                    eventstable.row.add([ data[key]["task_id"].slice(0,8) || "", data[key]["local_time"], data[key]["event"], data[key]["sender"], data[key]["target"], data[key]["file_count"], data[key]["info"] ])
                })
                eventstable.draw();
            },
            timeout: 3000
        });
    }

    function closeJobAuditTrail()
    {
        $("#jobaudittrail").removeClass("is-active");
    }

    function closeProcessLogs()
    {
        // Clear live logs polling if active
        if (liveLogsInterval) {
            clearInterval(liveLogsInterval);
            liveLogsInterval = null;
        }
        $("#process_logs").removeClass("is-active");
    }

    function closeProcessResults()
    {
        $("#process_results").removeClass("is-active");
    }

    function showJobInformation(jobId,category)
    {
        if ((jobId === "") || (category === "")) {
            return;
        }

        $('#jobinfo-renderer').jsonViewer();
        $("#jobinformation").addClass("is-active");
        $("#jobinfocontrol").addClass("is-loading");        

        $.ajax({
            type: 'POST',
            url: '/queue/jobinfo/' + category + '/' + jobId,
            data: { 'jobId': jobId },
            dataType: 'json',
            success: function (data) {
                textContent = ""
                try {
                    var jsondata = JSON.parse(data);
                    textContent = JSON.stringify(jsondata, null, 4);
                } catch(e) {
                    textContent = data;
                }                
                $('#jobinfo-renderer').jsonViewer(jsondata, {rootCollapsable: false, collapsed: true});
                $("#jobinfo-renderer > ul > li:nth-child(1) > a").click();                
            },
            error: function (data, status) {
                if (status === "parsererror") {                    
                    $("#jobinformationcontent").html(data.responseText);
                } else {
                    $("#jobinformationcontent").html("ERROR: Unable to retrieve job information");
                }
            },
            complete: function (data) {
                $("#jobinfocontrol").removeClass("is-loading");  
            }
        });
    }

    function closeJobInformation()
    {
        $("#jobinformation").removeClass("is-active");
        $('#jobinfo-renderer').jsonViewer();
    }

    function showArchiveJobInformation(jobId)
    {
        if (jobId === "") {
            return;
        }

        $('#json-renderer').jsonViewer({});
        $("#jobarchiveinformation").addClass("is-active");
        $("#jobarchiveinfocontrol").addClass("is-loading");        

        $.ajax({
            type: 'GET',
            url: '/api/get-task-info',
            data: {'task_id': jobId},
            dataType: 'json',
            error: function () {
                // $('#erroralert').show();
            },
            success: function (data) {
                $('#json-renderer').jsonViewer(data, {rootCollapsable: false, collapsed: true});
                $("#json-renderer > ul > li:nth-child(1) > a").click();
            },
            complete: function (data) {
                $("#jobarchiveinfocontrol").removeClass("is-loading");  
            },
            timeout: 3000
        });
    }

    function closeJobArchiveInformation()
    {
        $("#jobarchiveinformation").removeClass("is-active");
        $('#json-renderer').jsonViewer();
    }

    function restartJob(jobId)
    {
        if (jobId === "") {
            return;
        }

        $.ajax({
            type: 'POST',
            url: '/queue/jobs/fail/restart-job',
            data: {'task_id': jobId},
            dataType: 'json',
            error: function (data) {
                if (data.responseJSON.hasOwnProperty("error")) {
                    alert("Restart failed: " + data.responseJSON["error"])
                } else {
                    alert("Restart failed: unknown error.")
                }
            },
            success: function (data) {
                // check if error is a key in data
                if (data.hasOwnProperty("error")) {
                    alert("Restart failed: " + data["error"])
                } else {
                    alert("Job restarted")
                }
                update();
            },
            timeout: 3000
        });
    }

    function restartProcessingJob(jobId) {
        if (jobId === "") {
            return;
        }

        if (confirm("Are you sure you want to restart processing for this job using the original input files?")) {
            $.ajax({
                type: 'POST',
                url: '/queue/jobs/processing/restart-job',
                data: {'task_id': jobId},
                dataType: 'json',
                error: function () {
                    alert("Restart failed: unknown error.")
                },
                success: function (data) {
                    if (data.hasOwnProperty("error")) {
                        alert("Restart failed: " + data["error"])
                    } else {
                        alert("Job restarted with original input files")
                    }
                    update();
                },
                timeout: 3000
            });
        }
    }

    function deleteJob(jobId, category, force) {
        if (jobId === "") {
            return;
        }

        if (!force && !confirm("Are you sure you want to delete this job? This action cannot be undone.")) {
            return;
        }

        var url = '/queue/jobs/' + category + '/' + jobId;
        if (force) {
            url += '?force=true';
        }

        $.ajax({
            type: 'DELETE',
            url: url,
            dataType: 'json',
            error: function (xhr) {
                if (xhr.responseJSON && xhr.responseJSON.hasOwnProperty("error")) {
                    var errorMsg = xhr.responseJSON["error"];
                    // Offer force delete if job appears stuck in processing
                    if (errorMsg.indexOf("currently being processed") !== -1 || errorMsg.indexOf("force=true") !== -1) {
                        if (confirm("This job appears to be stuck in processing (possibly stale). Force delete?\n\nWarning: Only use this if you're sure the job is not actually running.")) {
                            deleteJob(jobId, category, true);
                            return;
                        }
                    }
                    alert("Delete failed: " + errorMsg);
                } else {
                    alert("Delete failed: unknown error.");
                }
            },
            success: function (data) {
                if (data.hasOwnProperty("error")) {
                    alert("Delete failed: " + data["error"]);
                } else {
                    alert("Job deleted successfully.");
                }
                update();
            },
            timeout: 5000
        });
    }

    function deleteArchiveJob(taskId) {
        if (taskId === "") {
            return;
        }

        if (!confirm("Are you sure you want to delete this task from the archive? This will remove the database records but not any files on disk.")) {
            return;
        }

        $.ajax({
            type: 'DELETE',
            url: '/queue/jobs/archive/' + taskId,
            dataType: 'json',
            error: function (xhr) {
                if (xhr.responseJSON && xhr.responseJSON.hasOwnProperty("error")) {
                    alert("Delete failed: " + xhr.responseJSON["error"]);
                } else {
                    alert("Delete failed: unknown error.");
                }
            },
            success: function (data) {
                if (data.hasOwnProperty("error")) {
                    alert("Delete failed: " + data["error"]);
                } else {
                    alert("Task deleted from archive successfully.");
                    $('#jobs_archive').DataTable().ajax.reload();
                }
            },
            timeout: 5000
        });
    }

    function showReprocessModal(jobId) {
        if (jobId === "") {
            return;
        }
        $('#reprocess_task_id').val(jobId);
        $('#use_current_settings').prop('checked', true);
        $('#custom_settings_field').hide();
        $('#custom_module_settings').val('{}');
        $('#reprocess_settings_modal').addClass('is-active');
    }

    function closeReprocessModal() {
        $('#reprocess_settings_modal').removeClass('is-active');
    }

    function confirmReprocess() {
        var taskId = $('#reprocess_task_id').val();
        var useCurrentSettings = $('#use_current_settings').is(':checked');
        var moduleSettings = $('#custom_module_settings').val();

        if (!useCurrentSettings) {
            try {
                JSON.parse(moduleSettings);
            } catch (e) {
                alert("Invalid JSON in custom settings. Please check the format.");
                return;
            }
        }

        $.ajax({
            type: 'POST',
            url: '/queue/jobs/fail/reprocess-with-settings',
            data: {
                'task_id': taskId,
                'use_current_settings': useCurrentSettings,
                'module_settings': moduleSettings
            },
            dataType: 'json',
            error: function (xhr) {
                if (xhr.responseJSON && xhr.responseJSON.hasOwnProperty("error")) {
                    alert("Reprocess failed: " + xhr.responseJSON["error"]);
                } else {
                    alert("Reprocess failed: unknown error.");
                }
            },
            success: function (data) {
                if (data.hasOwnProperty("error")) {
                    alert("Reprocess failed: " + data["error"]);
                } else {
                    alert(data.message || "Job queued for reprocessing.");
                    closeReprocessModal();
                    update();
                }
            },
            timeout: 10000
        });
    }

    function openPdfViewer(taskId, filename) {
        $('#pdf_frame').attr('src', '/api/task-pdf/' + taskId + '/' + filename);
        $('#pdf_viewer_modal').addClass('is-active');
    }

    function closePdfViewer() {
        $('#pdf_viewer_modal').removeClass('is-active');
        $('#pdf_frame').attr('src', '');
    }

    function checkAndOpenPreview(taskId) {
        $.ajax({
            url: '/api/task-dicom-files/' + taskId,
            success: function(data) {
                // Debug logging
                console.log('Preview API response:', data);
                console.log('Series count:', data.series_count);
                console.log('Series:', data.series);

                // Get all series (including PDFs now)
                var allSeries = data.series || [];

                console.log('All series:', allSeries.length, allSeries);

                if (allSeries.length > 1) {
                    // Multiple series (images and/or PDFs) - show series selector
                    console.log('Showing series selector for', allSeries.length, 'series');
                    showSeriesSelector(taskId, allSeries, data.files);
                } else if (allSeries.length === 1) {
                    // Single series - check if it's PDF or image
                    var series = allSeries[0];
                    if (series.is_pdf) {
                        var pdfFile = data.files.find(function(f) { return f.is_pdf; });
                        if (pdfFile) {
                            console.log('Opening PDF viewer for single PDF series');
                            openPdfViewer(taskId, pdfFile.filename);
                        }
                    } else {
                        console.log('Opening single image series directly:', series.series_uid);
                        openAdvancedDicomViewer(taskId, series.series_uid);
                    }
                } else if (data.files.length > 0) {
                    // Fallback: has files but no series info
                    console.log('Fallback: opening viewer without series filter');
                    openAdvancedDicomViewer(taskId);
                } else {
                    alert('No DICOM files found in output folder.');
                }
            },
            error: function(xhr) {
                if (xhr.status === 404) {
                    alert('Task output folder not found. The files may have been cleaned up or the task ID does not match a folder on disk.');
                } else if (xhr.status === 403) {
                    alert('Access denied. Please log in again.');
                } else {
                    alert('Could not access task output files: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'unknown error'));
                }
            }
        });
    }

    var updateTimer;

    function toggleAutoUpdate()
    {
        $("#autoupdate").toggleClass("is-dark");
        $("#autoupdate").blur();

        if ($("#autoupdate").hasClass("is-dark")) {
            updateTimer = setInterval(update, 10000);
        } else {
            clearInterval(updateTimer);
        }
    }

</script>

{% endblock %}
